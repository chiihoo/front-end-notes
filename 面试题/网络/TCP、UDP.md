**TCP是一个面向连接的、可靠的、基于字节流的传输层协议**

**UDP是一个面向无连接的传输层协议**  实时视频通信



**面向连接**：客户端和服务端在通信之前，会通过TCP三次握手来建立连接，而UDP没有建立连接的过程

**可靠性**：有状态和可控制。TCP会精准的记录哪些数据发送了，哪些数据被对方接收了，并且数据包要按序到达，不允许半点差错。并且如果丢包了或网络环境差，TCP会自动调整发送速度或者是重发。

**基于字节流**：TCP发送报文时，会将应用层的数据写入缓冲区，用TCP协议来控制发送，发送的状态就是字节流。而UDP的数据传输是基于报文的，它没有缓冲区，会将应用层数据加包头直接交给网络层





物理层 - 数据链路层 - 网络层 - 传输层 - 应用层

​                                        IP            TCP      HTTP

​                                                       UDP      FTP

​                                                                     DNS



**TCP如何保证可靠连接的？**

* 校验和：反码相加 首部与数据的16位字节，结果取反，接收端要重新校验，如果失败，丢弃这个报文段

* 序列号和确认应答号
* 重传机制：**超时重传，快速重传（收到三份相同的ACK报文时）**
* 三次握手、四次挥手
* 流量控制：接收端会在确认应答发送ACK报文时，将自己的即时窗口大小（缓冲区剩余大小）填入，发送方据此调节自己的发送速度
* 拥塞控制：网络没有出现拥塞，拥塞窗口就变大点，网络出现了拥塞，拥塞窗口就变小点





**滑动窗口**（流量控制）

**如果发送者发送数据过快，接收者来不及接收，那么就会有分组丢失。为了避免分组丢失，控制发送者的发送速度，使得接收者来得及接收，这就是流量控制。**



如果每发一次数据，要应答之后，才能发送下一个数据，这样，效率是比较低的

为了解决这个问题，TCP引入了窗口的概念，窗口实际是开辟出来的一个缓存空间，比如窗口的大小为3个TCP段，那么发送方就可以连续发送3个TCP段，如果中途有ACK丢失，则可以通过下一个确认应答进行确认

这个窗口的大小是接收方来决定的，接收方需要告诉发送方自己的缓冲区还可以接收多少数据

发送方的窗口

1. 已发送并收到确认的数据

2. 已发送但未收到确认的数据

3. 未发送但总大小在接收方处理范围的数据

4. 未发送且总大小超出接收方处理范围的数据

接收方的窗口

1. 已成功接收的数据
2. 未收到但可以接收的数据
3. 未收到且接收不了的数据



**拥塞控制**

**拥塞控制是作用于网络的，它是防止过多的数据注入到网络中，避免出现网络负载过大的情况**



1. **慢启动、拥塞避免**

刚开始拥塞窗口`cwnd`为1，发送端发数据发的很慢，一次传一个报文，之后每当发送端接到一个ACK确认应答后，拥塞窗口的大小+1，这样第二次发送端就可以发两个，再之后发四个，就这样指数上涨

当涨到慢启动门限`ssthresh`（比如为8个报文段）时

当 `cwnd` < `ssthresh` 时，拥塞窗口**按指数规律增长**；

当 `cwnd` > `ssthresh` 时，拥塞窗口**按线性规律增长**；

当发生**超时**时， `ssthresh` 的值**更新为发送窗口数值的一半**。重新进行慢开始



​                                               拥塞窗口

慢启动                                  指数增长

拥塞避免                              线性增长



超时			超时重传           门限变为一半，变为慢启动，拥塞窗口从1开始

​					快速重传           门限变为一半，变为快速恢复算法，拥塞窗口+3，重传丢失的数据包

​												如果再收到重复的ACK，cwnd+1。如果收到新数据的ACK，则cwnd恢复成之前的





**发生超时重传的拥塞发生算法**

![](https://gitee.com/chiihooy/pictures-bed/raw/master/img/20210312194243.png)



**发生快速重传的拥塞发生算法**

快速重传就是收到3个重复的ACK，会立刻重传



慢启动门限变为 发生快速重传时的一半，同时+3，之后是拥塞避免阶段

![](https://gitee.com/chiihooy/pictures-bed/raw/master/img/20210312194325.png)

![](https://uploadfiles.nowcoder.com/files/20200802/963196997_1596360795978_20200728230737.png)

![](https://uploadfiles.nowcoder.com/files/20200802/963196997_1596360807619_20200728230759.png)